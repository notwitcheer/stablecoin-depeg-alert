# Security Scanning Workflow
# Performs comprehensive security scans on code and dependencies

name: Security Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
    paths:
      - 'requirements*.txt'
      - 'Dockerfile'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'requirements*.txt'
      - 'Dockerfile'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Code Security Analysis
  code-security:
    name: Code Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep

    - name: Run Bandit security scan
      run: |
        echo "ðŸ”’ Running Bandit security analysis..."
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt

    - name: Run Semgrep security scan
      run: |
        echo "ðŸ” Running Semgrep security analysis..."
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=auto .

    - name: Upload security scan results
      uses: actions/upload-artifact@v3
      with:
        name: security-reports-${{ github.sha }}
        path: |
          bandit-report.json
          semgrep-report.json
        retention-days: 90

  # Dependency Security Analysis
  dependency-security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety pip-audit

    - name: Run Safety vulnerability scan
      id: safety-scan
      run: |
        echo "ðŸ›¡ï¸ Running Safety vulnerability scan..."
        safety check --json --output safety-report.json || true
        safety check --short-report

    - name: Run pip-audit scan
      id: pip-audit-scan
      run: |
        echo "ðŸ” Running pip-audit vulnerability scan..."
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit --format=cyclonedx-json --output=sbom.json || true
        pip-audit

    - name: Generate dependency tree
      run: |
        pip install pipdeptree
        pipdeptree --json > dependency-tree.json
        pipdeptree

    - name: Upload dependency security reports
      uses: actions/upload-artifact@v3
      with:
        name: dependency-security-${{ github.sha }}
        path: |
          safety-report.json
          pip-audit-report.json
          sbom.json
          dependency-tree.json
        retention-days: 90

  # Docker Security Scanning
  docker-security:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image for scanning
      run: |
        docker build -t depeg-alert:security-scan .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'depeg-alert:security-scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'trivy-fs-results.json'

    - name: Run Docker Scout security scan
      if: github.event_name == 'push' || github.event_name == 'schedule'
      uses: docker/scout-action@v1
      with:
        command: cves
        image: depeg-alert:security-scan
        format: json
        output: scout-results.json

    - name: Upload Docker security reports
      uses: actions/upload-artifact@v3
      with:
        name: docker-security-${{ github.sha }}
        path: |
          trivy-results.sarif
          trivy-fs-results.json
          scout-results.json
        retention-days: 90

  # Secrets Detection
  secrets-detection:
    name: Secrets Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run TruffleHog secrets scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: Run GitLeaks secrets scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}

  # Security Report Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [code-security, dependency-security, docker-security, secrets-detection]
    if: always()

    steps:
    - name: Download all security reports
      uses: actions/download-artifact@v3

    - name: Generate security summary
      run: |
        echo "ðŸ“Š Security Scan Summary" > security-summary.md
        echo "=========================" >> security-summary.md
        echo "" >> security-summary.md
        echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-summary.md
        echo "**Commit:** ${{ github.sha }}" >> security-summary.md
        echo "" >> security-summary.md

        # Process Bandit results
        if [ -f security-reports-*/bandit-report.json ]; then
          echo "## Code Security (Bandit)" >> security-summary.md
          issues=$(cat security-reports-*/bandit-report.json | jq '.results | length')
          echo "- Issues found: $issues" >> security-summary.md
          echo "" >> security-summary.md
        fi

        # Process Safety results
        if [ -f dependency-security-*/safety-report.json ]; then
          echo "## Dependency Security (Safety)" >> security-summary.md
          vulnerabilities=$(cat dependency-security-*/safety-report.json | jq '.vulnerabilities | length')
          echo "- Vulnerabilities found: $vulnerabilities" >> security-summary.md
          echo "" >> security-summary.md
        fi

        # Process Trivy results
        if [ -f docker-security-*/trivy-fs-results.json ]; then
          echo "## Container Security (Trivy)" >> security-summary.md
          critical=$(cat docker-security-*/trivy-fs-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length')
          high=$(cat docker-security-*/trivy-fs-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length')
          echo "- Critical vulnerabilities: $critical" >> security-summary.md
          echo "- High vulnerabilities: $high" >> security-summary.md
          echo "" >> security-summary.md
        fi

        echo "## Recommendations" >> security-summary.md
        echo "- Review all high and critical severity findings" >> security-summary.md
        echo "- Update dependencies with known vulnerabilities" >> security-summary.md
        echo "- Address code security issues identified by static analysis" >> security-summary.md
        echo "- Consider implementing additional security controls" >> security-summary.md

    - name: Upload security summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary-${{ github.sha }}
        path: security-summary.md
        retention-days: 90

    - name: Comment on PR with security summary
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('security-summary.md')) {
            const summary = fs.readFileSync('security-summary.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”’ Security Scan Results\n\n${summary}`
            });
          }

  # Create security issues for critical findings
  create-security-issues:
    name: Create Security Issues
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [security-summary]
    if: github.event_name == 'schedule' && needs.security-summary.result == 'success'

    steps:
    - name: Download security reports
      uses: actions/download-artifact@v3

    - name: Create issues for critical findings
      uses: actions/github-script@v7
      with:
        script: |
          // Check for critical security issues and create GitHub issues
          const fs = require('fs');

          let criticalIssues = [];

          // Check Trivy results for critical vulnerabilities
          try {
            if (fs.existsSync('docker-security-*/trivy-fs-results.json')) {
              const trivyResults = JSON.parse(fs.readFileSync('docker-security-*/trivy-fs-results.json', 'utf8'));
              const criticalVulns = [];

              trivyResults.Results?.forEach(result => {
                result.Vulnerabilities?.forEach(vuln => {
                  if (vuln.Severity === 'CRITICAL') {
                    criticalVulns.push(vuln);
                  }
                });
              });

              if (criticalVulns.length > 0) {
                criticalIssues.push({
                  title: `ðŸš¨ Critical Container Vulnerabilities Detected (${criticalVulns.length})`,
                  body: `Critical security vulnerabilities found in container dependencies:\n\n${criticalVulns.map(v => `- ${v.PkgName}: ${v.VulnerabilityID} (${v.Title})`).join('\n')}`,
                  labels: ['security', 'critical', 'container']
                });
              }
            }
          } catch (e) {
            console.log('Error processing Trivy results:', e);
          }

          // Create issues for critical findings
          for (const issue of criticalIssues) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issue.title,
              body: issue.body,
              labels: issue.labels
            });
          }