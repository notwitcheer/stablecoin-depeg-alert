# Dependency Update Workflow
# Automatically checks for dependency updates and creates PRs

name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools

    - name: Check for outdated packages
      id: check-outdated
      run: |
        echo "üì¶ Checking for outdated packages..."
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

        # Check for outdated packages
        outdated=$(pip list --outdated --format=json)
        echo "outdated-packages=$outdated" >> $GITHUB_OUTPUT

        # Count outdated packages
        count=$(echo "$outdated" | jq '. | length')
        echo "outdated-count=$count" >> $GITHUB_OUTPUT

        if [ "$count" -gt "0" ]; then
          echo "‚ö†Ô∏è Found $count outdated packages"
          echo "$outdated" | jq -r '.[] | "- \(.name): \(.version) ‚Üí \(.latest_version)"'
        else
          echo "‚úÖ All packages are up to date"
        fi

    - name: Check for security vulnerabilities
      id: security-check
      run: |
        echo "üîí Checking for security vulnerabilities..."
        pip install safety
        safety check --json --output safety-report.json || true

        if [ -f safety-report.json ]; then
          vulnerabilities=$(cat safety-report.json | jq '.vulnerabilities | length')
          echo "vulnerabilities-count=$vulnerabilities" >> $GITHUB_OUTPUT

          if [ "$vulnerabilities" -gt "0" ]; then
            echo "üö® Found $vulnerabilities security vulnerabilities"
          else
            echo "‚úÖ No security vulnerabilities found"
          fi
        fi

    - name: Create issue for outdated dependencies
      if: steps.check-outdated.outputs.outdated-count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const outdatedCount = '${{ steps.check-outdated.outputs.outdated-count }}';
          const vulnerabilitiesCount = '${{ steps.security-check.outputs.vulnerabilities-count }}' || '0';

          const title = `Dependency Updates Available (${outdatedCount} packages)`;
          const body = `
          ## üì¶ Dependency Update Report

          **Date:** ${new Date().toISOString().split('T')[0]}
          **Outdated Packages:** ${outdatedCount}
          **Security Vulnerabilities:** ${vulnerabilitiesCount}

          ### Outdated Packages

          ${{ steps.check-outdated.outputs.outdated-packages }}

          ### Security Status

          ${vulnerabilitiesCount > 0 ? 'üö® Security vulnerabilities detected!' : '‚úÖ No security vulnerabilities found'}

          ### Next Steps

          1. Review the outdated packages
          2. Test updates in a development environment
          3. Update requirements.txt files
          4. Run full test suite
          5. Deploy updates

          **Generated by:** Dependency Update Workflow
          `;

          // Check if issue already exists
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['dependencies'],
            state: 'open'
          });

          const existingIssue = issues.find(issue =>
            issue.title.includes('Dependency Updates Available')
          );

          if (existingIssue) {
            // Update existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              title: title,
              body: body
            });
            console.log(`Updated existing issue #${existingIssue.number}`);
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'maintenance']
            });
            console.log('Created new dependency update issue');
          }

  update-docker-base-images:
    name: Check Docker Base Images
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for updated base images
      run: |
        echo "üê≥ Checking for updated Docker base images..."

        # Get current Python image digest
        current_python=$(docker image inspect python:3.11-slim --format '{{.Id}}' 2>/dev/null || echo "not-found")

        # Pull latest image
        docker pull python:3.11-slim

        # Get new digest
        new_python=$(docker image inspect python:3.11-slim --format '{{.Id}}')

        echo "Current Python image: $current_python"
        echo "Latest Python image: $new_python"

        if [ "$current_python" != "$new_python" ]; then
          echo "‚úÖ Python base image has been updated"
          echo "base-image-updated=true" >> $GITHUB_OUTPUT
        else
          echo "‚ÑπÔ∏è Python base image is current"
          echo "base-image-updated=false" >> $GITHUB_OUTPUT
        fi

    - name: Create PR for base image update
      if: env.base-image-updated == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: prs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            head: 'update-base-images'
          });

          if (prs.length === 0) {
            // Create new branch and PR for base image updates
            const branchName = 'update-base-images';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üê≥ Update Docker base images',
              body: `
              ## Docker Base Image Update

              Updated base images are available:
              - python:3.11-slim

              ### Changes Made
              - Updated Python base image to latest version
              - Rebuilt Docker images with security patches

              ### Testing Required
              - [ ] Build and test Docker images
              - [ ] Run integration tests
              - [ ] Verify application functionality

              **Auto-generated by:** Docker Update Workflow
              `,
              labels: ['dependencies', 'docker', 'maintenance']
            });
          }